# Description: Shadow password file utilities
# URL:         http://shadow.pld.org.pl/
# Packager:    Per Lidén, per at fukt dot bth dot se
# Maintainer:  Johannes Winkelmann, jw at crux dot nu

name=shadow
version=4.0.18
release=1
source=(ftp://ftp.pld.org.pl/software/shadow/$name-$version.tar.bz2 \
        pwck login.defs \
        shadow-fix-useradd-usergroups.patch\
        shadow-4.0.15-nflg-conflict.diff \
        useradd-usergroup.diff \
        shadow-4.0.18-groupmems-nopam.diff
        limits.5 porttime.5 login.access.5)

build() {
    cd $name-$version
    patch src/useradd.c $SRC/shadow-fix-useradd-usergroups.patch
    patch src/useradd.c $SRC/shadow-4.0.15-nflg-conflict.diff 
    patch src/useradd.c $SRC/useradd-usergroup.diff
    patch src/groupmems.c $SRC/shadow-4.0.18-groupmems-nopam.diff

    ./configure --prefix=/usr \
                --mandir=/usr/man \
                --sysconfdir=/etc \
                --disable-shared \
                --disable-shadowgrp \
                --disable-nls \
                --without-selinux \
                --without-libpam

    cp $SRC/{limits.5,porttime.5,login.access.5} man
    make
    make DESTDIR=$PKG install
    mkdir -p $PKG/etc/cron/daily $PKG/var/log
    install -m 644 ../login.defs $PKG/etc
    install -m 755 ../pwck $PKG/etc/cron/daily
    mv $PKG/bin/{su,groups} $PKG/usr/bin
    touch $PKG/var/log/lastlog
    rm -rf $PKG/usr/bin/gpasswd \
	   $PKG/usr/man/man1/gpasswd.1 \
	   $PKG/usr/sbin/{chpasswd,grpconv,grpunconv,logoutd} \
	   $PKG/usr/sbin/{mkpasswd,newusers,pwconv,pwunconv} \
	   $PKG/usr/man/man8/{chpasswd.8,grpconv.8,grpunconv.8,logoutd.8} \
	   $PKG/usr/man/man8/{mkpasswd.8,newusers.8,pwconv.8,pwunconv.8} \
	   $PKG/usr/man/{man3,cs,de,es,fi,tr,fr,hu,id,it,ja,ko,pl,pt_BR,ru,zh_CN,zh_TW} \
	   $PKG/lib \
           $PKG/etc/{login.access,limits,default}

}
